# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.
# This file configures Charmcraft.
# See https://canonical-charmcraft.readthedocs-hosted.com/stable/howto/manage-charmcraft/
# for guidance.

type: charm
subordinate: true
name: aproxy
title: Aproxy Subordinate Charm
summary: A subordinate charm that deploys the aproxy application.
links:
  documentation: https://discourse.charmhub.io/t/aproxy-operator-documentation-overview/19030
  issues: https://github.com/canonical/aproxy-operator/issues
  source: https://github.com/canonical/aproxy-operator
  contact: https://launchpad.net/~canonical-is-devops

description: |
  The Aproxy subordinate charm installs and manages the aproxy snap to transparently
  intercept any per-unit TCP traffic and forward it to a target proxy, while preserving
  the original hostname.

  This charm is useful in environments that require transparent proxying for compliance,
  monitoring, or traffic redirection.

platforms:
  ubuntu@20.04:amd64:
  ubuntu@22.04:amd64:
  ubuntu@24.04:amd64:

requires:
  juju-info:
    interface: juju-info
    scope: container

parts:
  charm:
    source: .
    plugin: uv
    build-snaps:
    - astral-uv
config:
  options:
    proxy-address:
      description: |
        Configures the target proxy IP address and port for traffic forwarding.

        For example: "1.2.3.4:8888" or "1.2.3.4".
        If no proxy is specified, the default proxy is the juju-https-proxy or juju-http-proxy model configuration data.
        If no port is specified, the default port value of 80 will be used.
      type: string
    exclude-addresses-from-proxy:
      description: Comma-separated list of IP or hostname addresses that should bypass the proxy.
      default: "127.0.0.1"
      type: string
    intercept-ports:
      description: |
        Comma-separated list of ports to intercept and forward through the proxy.

        Support:
        - Single port e.g., 80
        - List of comma-separated ports e.g., 80,443
        - Range (both sides included) e.g., 1024-2048
        - List of ranges e.g. 80-90,1024-2048
        - Keyword "ALL" which corresponds to the range 1-65536
      default: "80,443"
      type: string
